generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  ADMIN
  WAITER
  CASHIER
  MANAGER
}

enum TableStatus {
  AVAILABLE
  OCCUPIED
  DIRTY
  RESERVED
}

enum MenuCategory {
  MAIN
  BEVERAGE
  DESSERT
  STARTER
  OTHER
}

enum MenuType {
  FOOD
  BEVERAGE
  WATER
  SPARKLING
  OTHER
}

enum OrderStatus {
  OPEN
  CLOSED
  PAID
  CANCELLED
}

enum OrderItemStatus {
  PENDING
  SERVED
  CANCELLED
}

enum BillStatus {
  PENDING
  PAID
  PARTIALLY_PAID
}

enum PaymentMethod {
  CASH
  CARD
  YAPE
  PLIN
  BANK_TRANSFER
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(WAITER)
  createdAt DateTime @default(now())
}

model RestaurantTable {
  id        Int         @id @default(autoincrement())
  name      String
  capacity  Int
  status    TableStatus @default(AVAILABLE)
  createdAt DateTime    @default(now())

  // reference to merged groups
  groupId   Int?
  group     TableGroup? @relation(fields: [groupId], references: [id])

  orders    Order[]
}

model TableGroup {
  id        Int         @id @default(autoincrement())
  createdAt DateTime     @default(now())

  tables    RestaurantTable[]

  orders    Order[]
}

//
// ===== MENU =====
//

model MenuItem {
  id         Int            @id @default(autoincrement())
  name       String
  category   MenuCategory
  description String?
  type       MenuType
  price      Decimal        @db.Decimal(10,2)
  isActive   Boolean        @default(true)

  orderItems OrderItem[]
  inventoryLinks MenuItemInventoryLink[]
}

//
// ===== ORDERS =====
//

model Order {
  id            Int          @id @default(autoincrement())
  tableId       Int?
  table         RestaurantTable? @relation(fields: [tableId], references: [id])

  tableGroupId  Int?
  tableGroup    TableGroup? @relation(fields: [tableGroupId], references: [id])

  status        OrderStatus  @default(OPEN)

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  orderItems    OrderItem[]
  bills         Bill[]
}

model OrderItem {
  id           Int             @id @default(autoincrement())
  orderId      Int
  menuItemId   Int
  quantity     Int
  notes        String?
  status       OrderItemStatus @default(PENDING)

  createdAt    DateTime        @default(now())

  order        Order           @relation(fields: [orderId], references: [id])
  menuItem     MenuItem        @relation(fields: [menuItemId], references: [id])

  // seat-based billing (more scalable than arrays)
  spots        OrderItemSpot[]
}

model OrderItemSpot {
  id         Int        @id @default(autoincrement())
  orderItemId Int
  seatNumber Int

  orderItem OrderItem  @relation(fields: [orderItemId], references: [id])
}

//
// ===== INVENTORY =====
//

model InventoryItem {
  id            Int                       @id @default(autoincrement())
  name          String
  category      String
  unit          String
  currentStock  Float
  minStock      Float
  isConsumable  Boolean                   @default(true)

  menuItemLinks MenuItemInventoryLink[]
}

model MenuItemInventoryLink {
  id              Int           @id @default(autoincrement())
  menuItemId      Int
  inventoryItemId Int
  quantityUsed    Float

  menuItem        MenuItem      @relation(fields: [menuItemId], references: [id])
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])
}

//
// ===== BILLING =====
//

model Bill {
  id        Int         @id @default(autoincrement())
  orderId   Int
  total     Decimal     @db.Decimal(10,2)
  status    BillStatus  @default(PENDING)
  createdAt DateTime    @default(now())

  payments  Payment[]
  splits    BillSplit[]
  order     Order       @relation(fields: [orderId], references: [id])
}

model BillSplit {
  id         Int         @id @default(autoincrement())
  billId     Int
  seatNumber Int
  amount     Decimal     @db.Decimal(10,2)
  isPaid     Boolean     @default(false)

  bill       Bill        @relation(fields: [billId], references: [id])
}

model Payment {
  id        Int             @id @default(autoincrement())
  billId    Int
  amount    Decimal         @db.Decimal(10,2)
  method    PaymentMethod
  reference String?
  paidAt    DateTime        @default(now())

  bill      Bill            @relation(fields: [billId], references: [id])
}

//
// ===== DAILY SUMMARY (analytics / caching) =====
//

model DailySummary {
  id            Int       @id @default(autoincrement())
  date          DateTime  @unique @db.Date
  totalSales    Decimal   @db.Decimal(12,2)
  itemsSold     Json?
  lowStockItems Json?
  generatedAt   DateTime  @default(now())
}
